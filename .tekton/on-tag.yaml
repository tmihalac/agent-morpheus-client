---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: morpheus-client-on-tag-push
  annotations:
    # The event we are targeting as seen from the webhook payload
    # this can be an array too, i.e: [pull_request, push]
    pipelinesascode.tekton.dev/on-event: "[push]"

    # The branch or tag we are targeting (ie: main, refs/tags/*)
    pipelinesascode.tekton.dev/on-target-branch: "[refs/tags/*]"

    # Fetch the git-clone task from hub, we are able to reference later on it
    # with taskRef and it will automatically be embedded into our pipeline.
    pipelinesascode.tekton.dev/task: "git-clone"

    # How many runs we want to keep.
    pipelinesascode.tekton.dev/max-keep-runs: "5"
spec:
  params:
    # The variable with brackets are special to Pipelines as Code
    # They will automatically be expanded with the events from Github.
    - name: repo_url
      value: "{{ repo_url }}"
    - name: revision
      value: "{{ revision }}"
    - name: output-image
      value: quay.io/ecosystem-appeng/agent-morpheus-client
    - name: tag-name
      value: "{{git_tag}}"
    - name: path-context
      value: .
    - name: dockerfile
      value: ./src/main/docker/Dockerfile.multi-stage
  pipelineSpec:
    params:
      - name: repo_url
      - name: revision
      - name: tag-name
      - name: output-image
        description: Fully Qualified Output Image
        type: string
      - name: path-context
        default: .
        description: Path to the source code of an application's component from where to build image.
        type: string
      - name: dockerfile
        default: Dockerfile
        description: Path to the Dockerfile inside the context specified by parameter path-context
        type: string
    workspaces:
      - name: source
    tasks:
      - name: fetch-repository
        taskRef:
          resolver: cluster
          params:
            - name: kind
              value: task
            - name: name
              value: git-clone
            - name: namespace
              value: openshift-pipelines
        workspaces:
          - name: output
            workspace: source
        params:
          - name: URL
            value: $(params.repo_url)
          - name: REVISION
            value: $(params.revision)
      - name: format-image-name
        params:
          - name: image_name
            value: $(params.output-image)
          - name: tag_name
            value: $(params.tag-name)
        taskSpec:
          params:
            - name: image_name
              type: string
            - name: tag_name
              type: string
          results:
            - name: target-image
          steps:
            - name: format-image
              image: registry.redhat.io/ubi9/ubi-minimal:9.4
              script: |
                #!/usr/bin/env bash
                IMAGE="$(params.image_name):$(echo $(params.tag_name) | sed 's|refs/tags/||')"
                echo "Building image: $IMAGE"

                # Set the formatted image as an output
                echo -n "${IMAGE}" > "$(results.target-image.path)"
      - name: buildah
        runAfter:
          - fetch-repository
        params:
          - name: IMAGE
            value: $(tasks.format-image-name.results.target-image)
          - name: DOCKERFILE
            value: $(params.dockerfile)
          - name: CONTEXT
            value: $(params.path-context)
          - name: BUILDER_IMAGE
            value: >-
              registry.redhat.io/rhel8/buildah@sha256:aac6629389db17e99894c5bee0da01d4c8065d11d8c6f6e1602f9484290baa70
          - name: BUILD_EXTRA_ARGS
            value: >-
              --ulimit nofile=550000:550000
              --env=EXPLOIT_IQ_CLIENT_VERSION={{git_tag}}
              --env=INCLUDE_SWAGGER_UI=false
              --env=QUARKUS_SWAGGER_UI_ALWAYS_INCLUDE=false

        taskRef:
          resolver: cluster
          params:
            - name: kind
              value: task
            - name: name
              value: buildah
            - name: namespace
              value: openshift-pipelines
        workspaces:
          - name: source
            workspace: source
          - name: dockerconfig
            workspace: dockerconfig-ws
  workspaces:
  - name: source
    volumeClaimTemplate:
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
  - name: dockerconfig-ws
    secret:
      secretName: ips-for-client-build
