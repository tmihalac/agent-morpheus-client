quarkus.application.name=exploit-iq-client

quarkus.quinoa.package-manager-install=true
quarkus.quinoa.package-manager-install.node-version=20.10.0

quarkus.rest.path=/api/v1
quarkus.rest-client.github.url=https://api.github.com
quarkus.rest-client.github.headers.Authorization=Bearer ${GITHUB_TOKEN}
quarkus.rest-client.github.headers.User-Agent=exploit-iq
quarkus.rest-client.morpheus.url=https://agent-morpheus:8080/generate
%dev.quarkus.rest-client.morpheus.url=http://localhost:26466/generate
%dev.NAMESPACE=local-dev
quarkus.rest-client.component-syncer.url=http://job-sink.knative-eventing.svc.cluster.local/${NAMESPACE}/component-syncer
%dev.quarkus.rest-client.component-syncer.url=http://localhost:8088/${NAMESPACE:exploit-iq}/component-syncer
# Build-time property. Set INCLUDE_SWAGGER_UI=false during build for production.
quarkus.swagger-ui.always-include=${INCLUDE_SWAGGER_UI:true}
quarkus.http.filter.others.header.Cache-Control=no-cache
quarkus.http.filter.others.matches=/.*
quarkus.http.filter.others.methods=GET
quarkus.http.filter.others.order=0
quarkus.http.filter.static.header.Cache-Control=max-age=31536000
quarkus.http.filter.static.matches=/static/.+
quarkus.http.filter.static.methods=GET
quarkus.http.filter.static.order=1
quarkus.http.enable-compression=true

quarkus.mongodb.database=${MONGODB_DATABASE:exploit-iq-client}
quarkus.mongodb.credentials.auth-source=exploit-iq-client
%prod.quarkus.mongodb.hosts=${MONGODB_SVC_HOST}:${MONGODB_SVC_PORT}
%prod.quarkus.mongodb.credentials.username=${MONGODB_USERNAME}
%prod.quarkus.mongodb.credentials.password=${MONGODB_PASSWORD}
quarkus.native.resources.includes=includes.json,excludes.json,preProcessingTemplate.json
quarkus.http.limits.max-body-size=1G
quarkus.rest-client.morpheus.read-timeout=300000

# ============================================================================
# OIDC CONFIGURATION PROFILES
# ============================================================================
# 
# Profile: prod (default)
#   Use case: OpenShift with internal OAuth2
#   Activation: QUARKUS_PROFILE=prod
#   Required environment variables: OPENSHIFT_DOMAIN, OAUTH_CLIENT_SECRET
#
# Profile: external-idp
#   Use cases:
#     - OpenShift/Kubernetes with Keycloak (standalone or as Identity Broker)
#     - Direct GitHub/Google OAuth (without Keycloak)
#   Activation: QUARKUS_PROFILE=external-idp
#   Required environment variables:
#     For Keycloak: QUARKUS_OIDC_AUTH_SERVER_URL, QUARKUS_OIDC_CREDENTIALS_SECRET
#     For Direct Google/GitHub: QUARKUS_OIDC_PROVIDER=google|github,
#       QUARKUS_OIDC_CLIENT_ID, QUARKUS_OIDC_CREDENTIALS_SECRET
#
# Profile: dev
#   Use case: Local development with Keycloak DevServices
#   Activation: ./mvnw quarkus:dev
#   Auto-configured: Keycloak DevServices
#
# ============================================================================

# Base OIDC Configuration
quarkus.oidc.application-type=hybrid
quarkus.oidc.cache-user-info-in-idtoken=true
quarkus.oidc.token.verify-access-token-with-user-info=false
quarkus.oidc.authentication.id-token-required=false
quarkus.oidc.client-id=exploit-iq-client

# --- PROFILE: dev (Keycloak DevServices) ---
# Read roles from JWT access token (Keycloak stores roles there)
%dev.quarkus.oidc.roles.source=accesstoken

# --- PROFILE: prod (OpenShift with internal OAuth2) ---
%prod.quarkus.oidc.allow-token-introspection-cache=false
%prod.quarkus.oidc.auth-server-url=https://oauth-openshift.apps.${OPENSHIFT_DOMAIN}
%prod.quarkus.oidc.authentication.add-openid-scope=false
%prod.quarkus.oidc.authentication.scopes=user:info,user:check-access
%prod.quarkus.oidc.authorization-path=/oauth/authorize
%prod.quarkus.oidc.credentials.secret=${OAUTH_CLIENT_SECRET}

%prod.quarkus.oidc.discovery-enabled=false
%prod.quarkus.oidc.jwks-path=https://api.${OPENSHIFT_DOMAIN}:6443/openid/v1/jwks
%prod.quarkus.oidc.token-path=/oauth/token
%prod.quarkus.oidc.token.allow-jwt-introspection=false
%prod.quarkus.oidc.token.require-jwt-introspection-only=false
%prod.quarkus.oidc.user-info-path=https://api.${OPENSHIFT_DOMAIN}:6443/apis/user.openshift.io/v1/users/~
# Read roles from UserInfo endpoint (OpenShift returns groups only in UserInfo, not in JWT)
%prod.quarkus.oidc.roles.source=userinfo
%prod.quarkus.oidc.roles.role-claim-path=groups

# --- PROFILE: external-idp (External Identity Provider) ---
# Supports: Keycloak (standalone or broker), GitHub, Google, Auth0, etc.
%external-idp.quarkus.oidc.application-type=hybrid
%external-idp.quarkus.oidc.authentication.add-openid-scope=true
%external-idp.quarkus.oidc.authentication.id-token-required=true
%external-idp.quarkus.oidc.authentication.scopes=openid,profile,email
%external-idp.quarkus.oidc.discovery-enabled=true
%external-idp.quarkus.oidc.token.verify-access-token-with-user-info=false
# Read roles from Access Token (Keycloak stores roles in JWT)
%external-idp.quarkus.oidc.roles.source=accesstoken

# OpenShift OAuth -
# ==============================================================================
# RBAC (Role-Based Access Control)
# ==============================================================================
# Strategy:
# - Global policy: Authenticated + Role (exploit-iq-view, exploit-iq-prodsec, exploit-iq-admin).
# - Exceptions: Specific paths (logout, health, dev-ui) are permitted.
# ==============================================================================

# Allow logout for all authenticated users (even without roles)
quarkus.http.auth.permission.logout.paths=/api/v1/user/logout
quarkus.http.auth.permission.logout.policy=permit


# Allow health endpoints (for monitoring)
quarkus.http.auth.permission.management.paths=/health,/health/*
quarkus.http.auth.permission.management.policy=permit


# Allow dev UI in development mode
%dev.quarkus.http.auth.permission.dev-ui.paths=/q/*
%dev.quarkus.http.auth.permission.dev-ui.policy=permit

# Global policy: Require authentication and at least one role
quarkus.http.auth.policy.role-policy.roles-allowed=exploit-iq-view,exploit-iq-prodsec,exploit-iq-admin,system:serviceaccounts:${NAMESPACE}
quarkus.http.auth.permission.default.paths=/*
quarkus.http.auth.permission.default.policy=role-policy
# No order specified = lowest priority (applied last, after exceptions)


# Smallrye Health UI is disabled by default in production environment
%prod.quarkus.smallrye-health.ui.enabled=false
# quarkus.log.category."io.quarkus.oidc".level=DEBUG
# quarkus.log.category."io.quarkus.oidc".min-level=DEBUG

%dev.quarkus.log.category."com.redhat.ecosystemappeng.morpheus".level=DEBUG
%dev.quarkus.keycloak.devservices.realm-path=src/test/resources/devservices/keycloak-realm.json
%dev.quarkus.wiremock.devservices.reload=true
%dev.quarkus.wiremock.devservices.files-mapping=src/test/resources/devservices/wiremock
#%dev.quarkus.rest-client.github.url=https://api.github.com
#%dev.quarkus.rest-client.morpheus.url=http://localhost:${quarkus.wiremock.devservices.port}/morpheus/scan
%dev.quarkus.oidc.credentials.secret=example-credentials
# Dev: Auth disabled by default. Enable with:
# -Dquarkus.oidc.enabled=true -Dquarkus.keycloak.devservices.enabled=true
%dev.quarkus.oidc.enabled=false
%dev.quarkus.keycloak.devservices.enabled=false
%dev.quarkus.keycloak.devservices.container-memory-limit=2G

# Management interface
quarkus.management.enabled=true
quarkus.management.port=9000
quarkus.management.proxy.paths=/health,/health-ui,/metrics,/info
#Current mappings
#quarkus.micrometer.binder.http-server.match-patterns=\
#  /reports/new,\
#  /reports/.*/retry+=/reports/{id}/retry,\
#  /reports/.*+=/reports/{id},\
#  /vulnerabilities/.*/comments+=/vulnerabilities/{vuln_id}/comments,\
#  /vulnerabilities/.*+=/vulnerabilities/{vuln_id}
quarkus.micrometer.binder.http-server.ignore-patterns=^(?!/reports|/vulnerabilities).*$

#quarkus.otel.exporter.otlp.enabled=false
#quarkus.opentelemetry.tracer.exporter.otlp.enabled=false
quarkus.log.console.format=%d{HH:mm:ss} %-5p traceId=%X{traceId}, parentId=%X{parentId}, spanId=%X{spanId}, sampled=%X{sampled} [%c{2.}] (%t) %s%e%n

# Queue settings
morpheus.queue.max-active=20
morpheus.queue.timeout=2h

# Component Syncer settings
morpheus.syncer.timeout=2h
morpheus.syncer.health.url=http://job-sink.knative-eventing.svc.cluster.local/${NAMESPACE}/component-syncer
%dev.morpheus.syncer.health.url=http://localhost:8088/${NAMESPACE:exploit-iq}/component-syncer
morpheus.syncer.health.timeout=2000ms

# Syft settings
morpheus.syft.cache.dir=${SYFT_CACHE_DIR:/work/.cache/syft}

# Feedback API settings
quarkus.rest-client.feedback-api.url=http://morpheus-feedback-api:5001
%dev.quarkus.rest-client.feedback-api.url=http://localhost:5001

# Engine settings
morpheus.engine.health.url=http://exploit-iq:8080/health
%dev.morpheus.engine.health.url=http://localhost:26466/health
morpheus.engine.health.timeout=2000ms
